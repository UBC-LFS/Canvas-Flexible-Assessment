{% extends "accommodations/accommodations_base.html" %}
{% load django_bootstrap5 %}
{% bootstrap_messages %}
{% load static %}
{% bootstrap_css %}
{% bootstrap_javascript %}
{% bootstrap_messages %}
{% block content %}
    <style>
        .disabled-table table {
            background-color: #f8f9fa;
        }

        .disabled-table td,
        .disabled-table th {
            color: rgba(114, 114, 117, 0.5); /* Bootstrap body text, faded */
        }

        .disabled-table a {
            color: #0d6efd !important; /* Bootstrap primary link color */
        }

        .disabled-table a:hover {
            color: #0a58ca !important; /* Darker hover state */
        }

        /*
        .disabled-table thead th {
            border-bottom: 1px solid #dee2e6 !important; 
        } */

        /* Tooltip container */
        .custom-tooltip {
        position: relative;
        display: inline-block;
        }

        /* Tooltip text */
        .custom-tooltip .tooltiptext {
        visibility: hidden;
        width: 200px;
        background-color: #555;
        color: #fff;
        text-align: center;
        padding: 5px 0;
        border-radius: 6px;

        /* Position the tooltip text */
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -100px;

        /* Fade in tooltip */
        opacity: 0;
        transition: opacity 0.3s;
        }

        /* Tooltip arrow */
        .custom-tooltip .tooltiptext::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #555 transparent transparent transparent;
        }

        /* Show the tooltip text when you mouse over the tooltip container */
        .custom-tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
        }
    </style>
    <div class="container my-4">
        <h2 class="text-center">Accommodations</h2>
        <div class="row justify-content-center mt-4">
            <div class="col-lg-10 col-md-12">
                <form id="quiz-upload-form"
                      method="post"
                      action="{% url 'accommodations:accommodations_quizzes' course.id %}">
                    {% csrf_token %}
                    <div class="my-3">
                        <h4>Select Quizzes</h4>
                        <label class="form-label mb-3">
                            Please select the quizzes in your course that you would like to apply accommodations to:
                        </label>
                        <!-- Valid Quizzes -->
                        <div class="ms-3">
                            <div class="row g-3">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th scope="col">
                                                <input class="form-check-input me-3" type="checkbox" id="select-all">
                                            </th>
                                            <th scope="col">Quizzes ({{ quizzes|length }})</th>
                                            <th scope="col">Start Date</th>
                                            <th scope="col">End Date</th>
                                            <th scope="col">Time Limit</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for quiz in quizzes %}
                                            <tr>
                                                <th scope="col">
                                                    <input class="form-check-input me-2 quiz-checkbox"
                                                           type="checkbox"
                                                           name="selected_quizzes"
                                                           value="{{ quiz.id }}"
                                                           id="quiz{{ quiz.id }}"
                                                           {% if quiz in selected_quizzes %}checked{% endif %}>
                                                </th>
                                                <td>
                                                    <a href="{{ quiz.url }}" target="_blank">{{ quiz.title }}</a>
                                                </td>
                                                <td>
                                                    <span class="{% if not quiz.unlock_at_readable %}text-muted {% endif %}">
                                                        {{ quiz.unlock_at_readable|default:"No time set" }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="{% if not quiz.lock_at_readable %}text-muted {% endif %}">
                                                        {{ quiz.lock_at_readable|default:"No time set" }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="{% if not quiz.time_limit_readable %}text-muted {% endif %}">
                                                        {{ quiz.time_limit_readable|default:"No time limit set" }}
                                                    </span>
                                                    {% if quiz.should_warn %}
                                                        <div class="custom-tooltip">
                                                            <i class="bi bi-exclamation-triangle text-danger ms-1"></i>
                                                            <span class="tooltiptext">Warning: quiz time limit exceeds the time between the start date and end date.</span>
                                                        </div>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <h4 class="mt-4">Quizzes without Current Dates/Times</h4>
                        <label class="form-label mb-3">
                            These quizzes cannot have accommodations applied to them. In order to be eligible for accommodations, a quiz must have a time limit and/or a valid start and end date.
                        </label>
                        <!--Invalid Quizzes-->
                        <div class="ms-3 disabled-table">
                            <div class="row g-3">
                                <table class="table table-bordered">
                                    <thead>
                                        <th scope="col">Quizzes ({{ unavailable_quizzes|length }})</th>
                                        <th scope="col">Start Date</th>
                                        <th scope="col">End Date</th>
                                        <th scope="col">Time Limit</th>
                                    </thead>
                                    <tbody>
                                        {% for quiz in unavailable_quizzes %}
                                            <tr>
                                                <td>
                                                    <a href="{{ quiz.url }}" target="_blank">{{ quiz.title }}</a>
                                                </td>
                                                <td>{{ quiz.unlock_at_readable|default:"No time set" }}</td>
                                                <td>{{ quiz.lock_at_readable|default:"No time set" }}</td>
                                                <td>{{ quiz.time_limit_readable|default:"No time limit set" }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Buttons -->
                        <div class="mt-4 d-flex justify-content-between">
                            <!-- Back button using JavaScript -->
                            <button type="button"
                                    class="btn btn-secondary"
                                    onclick="window.location.href='{% url 'accommodations:accommodations_home' course.id %}'">
                                <i class="bi bi-arrow-left me-1"></i>
                                Back
                            </button>
                            <!-- Next button -->
                            <button type="submit" class="btn btn-primary">
                                Next <i class="bi bi-arrow-right ms-1"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% if messages %}
        <ul class="messages" hidden>
            {% for message in messages %}
                <li {% if message.tags %}class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const selectAll = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.quiz-checkbox');
            const quizForm = document.getElementById("quiz-upload-form");

            // on submitting form, make sure at least one quiz is selected
            quizForm.addEventListener("submit", function (e) {
                let none_checked = true;
                checkboxes.forEach(cb => {
                    if (cb.checked) {
                        none_checked = false;
                    }
                });
                if (none_checked) {
                    e.preventDefault();
                    alert("Please select at least one quiz before submitting.");
                }
            });

            selectAll.addEventListener('change', function () {
                checkboxes.forEach(cb => {
                    cb.checked = this.checked;
                });
            });

            // check selectAll when page first loads
            if (Array.from(checkboxes).every(cb => cb.checked)) {
                selectAll.checked = true;
            }

            
            checkboxes.forEach(cb => {
                cb.addEventListener('change', () => {

                    if (!cb.checked) {
                        selectAll.checked = false;
                    } else if (Array.from(checkboxes).every(cb => cb.checked)) {
                        selectAll.checked = true;
                    }
                });
            });


        });
    </script>
{% endblock %}
