{% extends "accommodations/accommodations_base.html" %}
{% load django_bootstrap5 %}
{% bootstrap_messages %}
{% load static %}
{% bootstrap_css %}
{% bootstrap_javascript %}
{% bootstrap_messages %}
{% block content %}
    <style>
        #quiz-card {
            transition: background-color 0.1s, border-color 0.1s;
        }

        #quiz-card:hover {
            background-color: #e0f3ff;
            border-color: #0056b3;
        }

        .underline-if-exists {
            text-decoration: underline;
        }
    </style>
    <div class="container my-4">
        <h2 class="text-center">Accommodations</h2>
        <div class="row justify-content-center mt-4">
            <div class="col-lg-6 col-md-8">
                <form id="quiz-upload-form"
                      method="post"
                      action="{% url 'accommodations:accommodations_quizzes' course.id %}">
                    {% csrf_token %}
                    <div class="my-3">
                        <h4>Select Quizzes</h4>
                        <label class="form-label my-3">
                            Please select the quizzes in your course that you would like to apply accommodations to:
                        </label>
                        <!-- Select All Checkbox -->
                        <div class="form-check d-flex align-items-center mb-3">
                            <input class="form-check-input me-3" type="checkbox" id="select-all">
                            <label class="form-check-label fw-bold fs-4 mb-0" for="select-all">Select All</label>
                        </div>
                        <!-- Individual Quiz Checkboxes -->
                        <!-- Individual Quiz Checkboxes -->
                        <div class="ms-3">
                            <div class="row g-3">
                                {% for quiz in quizzes %}
                                    <div class="col-12">
                                        <div class="card quiz-card shadow-sm p-1"
                                             id="quiz-card"
                                             data-checkbox-id="quiz{{ quiz.id }}">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center mb-1 mt-0">
                                                    <input class="form-check-input me-2 quiz-checkbox"
                                                           type="checkbox"
                                                           name="quizzes"
                                                           value="{{ quiz.id }}"
                                                           id="quiz{{ quiz.id }}">
                                                    <label class="form-check-label fs-5 fw-bold mb-0 d-flex w-100 align-items-center"
                                                           for="quiz{{ quiz.id }}">
                                                        <span>{{ quiz.title }}</span>
                                                        <i class="bi ms-auto {% if quiz.published %}bi-check-circle-fill text-success{% else %}bi-ban{% endif %}"></i>
                                                    </label>
                                                </div>
                                                <ul class="list-unstyled ms-4 mb-0">
                                                    <li>
                                                        Time Limit:
                                                        <span class="{% if not quiz.time_limit_readable %}text-muted {% else %} underline-if-exists{% endif %}">
                                                            {{ quiz.time_limit_readable|default:"No time limit set" }}
                                                        </span>
                                                    </li>
                                                    <li>
                                                        Quiz Open From:
                                                        <span class="{% if not quiz.unlock_at_readable %}text-muted {% else %} underline-if-exists{% endif %}">
                                                            {{ quiz.unlock_at_readable|default:"No time set" }}
                                                        </span>
                                                        to
                                                        <span class="{% if not quiz.lock_at_readable %}text-muted {% else %} underline-if-exists{% endif %}">
                                                            {{ quiz.lock_at_readable|default:"No time set" }}
                                                        </span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <!-- Buttons -->
                        <div class="mt-4 d-flex justify-content-between">
                            <!-- Back button using JavaScript -->
                            <button type="button"
                                    class="btn btn-secondary"
                                    onclick="window.location.href='{% url 'accommodations:accommodations_home' course.id %}'">
                                Back
                            </button>
                            <!-- Next button -->
                            <button type="submit" class="btn btn-primary">Next</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% if messages %}
        <ul class="messages" hidden>
            {% for message in messages %}
                <li {% if message.tags %}class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const selectAll = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.quiz-checkbox');
            const cards = document.querySelectorAll('.quiz-card');

            const quizForm = document.getElementById("quiz-upload-form");

            // on submitting form, make sure at least one quiz is selected
            quizForm.addEventListener("submit", function (e) {
                let none_checked = true;
                checkboxes.forEach(cb => {
                    if (cb.checked) {
                        none_checked = false;
                    }
                });
                if (none_checked) {
                    e.preventDefault();
                    alert("Please select at least one quiz before submitting.");
                }
            });

            selectAll.addEventListener('change', function () {
                checkboxes.forEach(cb => cb.checked = this.checked);
            });

            checkboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    if (!cb.checked) {
                        selectAll.checked = false;
                    } else if (Array.from(checkboxes).every(cb => cb.checked)) {
                        selectAll.checked = true;
                    }
                });
            });

            cards.forEach(card => {
                card.classList.add('cursor-pointer');

                card.addEventListener('click', function (e) {
                    // Prevent double toggle when clicking directly on input/label
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'LABEL') return;

                    const checkboxId = card.getAttribute('data-checkbox-id');
                    const checkbox = document.getElementById(checkboxId);
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));  // sync with Select All logic
                    }
                });
            });
        });
    </script>
{% endblock %}
